---

---

<dialog
    id="command-palette"
    class="backdrop:backdrop-blur-sm bg-transparent p-0 m-auto w-full max-w-2xl text-left shadow-2xl rounded-xl open:animate-in open:fade-in open:zoom-in-95 backdrop:animate-in backdrop:fade-in"
>
    <div
        class="bg-slate-900 border border-slate-700/50 rounded-xl overflow-hidden shadow-2xl flex flex-col max-h-[60vh] text-slate-200 font-sans"
    >
        <!-- Search Input -->
        <div class="border-b border-slate-800 p-4 flex items-center gap-3">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="text-slate-500"
                ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
                ></path></svg
            >
            <input
                type="text"
                id="cp-input"
                placeholder="Type a command or search..."
                class="bg-transparent border-none outline-none flex-grow text-lg placeholder:text-slate-600 focus:ring-0"
                autocomplete="off"
            />
            <kbd
                class="hidden md:inline-flex items-center gap-1 px-2 py-1 text-xs font-mono text-slate-500 bg-slate-800/50 rounded border border-slate-700"
                >ESC</kbd
            >
        </div>

        <!-- Results List -->
        <div
            id="cp-results"
            class="overflow-y-auto p-2 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent"
        >
            <!-- Populated via JS -->
        </div>

        <!-- Footer -->
        <div
            class="border-t border-slate-800 p-2 px-4 bg-slate-950/30 text-xs text-slate-500 flex justify-between"
        >
            <div>
                <span class="font-medium text-blue-400">â†‘â†“</span> to navigate
                <span class="font-medium text-blue-400 ml-2">â†µ</span> to select
            </div>
            <div>VirtualSach.in OS v1.0</div>
        </div>
    </div>
</dialog>

<script>
    const dialog = document.getElementById(
        "command-palette",
    ) as HTMLDialogElement;
    const input = document.getElementById("cp-input") as HTMLInputElement;
    const resultsContainer = document.getElementById("cp-results");

    // Data Source
    const commands = [
        { category: "Navigation", icon: "ðŸ ", title: "Go Home", href: "/" },
        {
            category: "Navigation",
            icon: "ðŸ‘¤",
            title: "About Me",
            href: "/about",
        },
        {
            category: "Navigation",
            icon: "ðŸ“¬",
            title: "Contact",
            href: "/contact",
        },
        {
            category: "Navigation",
            icon: "âš¡",
            title: "Uses",
            href: "/uses",
        },
        {
            category: "Navigation",
            icon: "ðŸ“",
            title: "Insights (Blog)",
            href: "/blog",
        },
        {
            category: "Navigation",
            icon: "ðŸš€",
            title: "Projects",
            href: "/projects",
        },
        {
            category: "Social",
            icon: "ðŸ™",
            title: "GitHub Profile",
            href: "https://github.com/virtualsach",
            external: true,
        },
        {
            category: "Social",
            icon: "ðŸ’¼",
            title: "LinkedIn",
            href: "https://www.linkedin.com/in/virtualsachin/",
            external: true,
        },
        {
            category: "Social",
            icon: "ðŸ¦",
            title: "Twitter / X",
            href: "https://twitter.com/virtualsachin",
            external: true,
        },
        {
            category: "Action",
            icon: "ðŸ“§",
            title: "Send Email",
            href: "mailto:sachin@example.com",
        },
    ];

    let selectedIndex = 0;
    let filteredCommands = [...commands];

    function openPalette() {
        if (dialog.open) return;
        dialog.showModal();
        input.value = "";
        filterCommands("");
        input.focus();
    }

    function closePalette() {
        dialog.close();
    }

    function filterCommands(query: string) {
        const q = query.toLowerCase();
        filteredCommands = commands.filter(
            (cmd) =>
                cmd.title.toLowerCase().includes(q) ||
                cmd.category.toLowerCase().includes(q),
        );
        selectedIndex = 0;
        render();
    }

    function render() {
        if (!resultsContainer) return;
        resultsContainer.innerHTML = "";

        if (filteredCommands.length === 0) {
            resultsContainer.innerHTML = `<div class="p-4 text-center text-slate-500">No results found.</div>`;
            return;
        }

        let currentCategory = "";

        filteredCommands.forEach((cmd, index) => {
            // Category Header
            if (cmd.category !== currentCategory) {
                const header = document.createElement("div");
                header.className =
                    "px-3 py-2 text-xs font-semibold text-slate-500 uppercase tracking-wider mt-2 first:mt-0";
                header.textContent = cmd.category;
                resultsContainer.appendChild(header);
                currentCategory = cmd.category;
            }

            // Command Item
            const item = document.createElement("button");
            item.className = `w-full text-left px-3 py-3 rounded-lg flex items-center gap-3 transition-colors ${index === selectedIndex ? "bg-blue-600/20 text-blue-200" : "text-slate-300 hover:bg-white/5"}`;
            item.innerHTML = `
                <span class="text-lg">${cmd.icon}</span>
                <span class="flex-grow font-medium">${cmd.title}</span>
                ${cmd.external ? '<span class="text-xs opacity-50">â†—</span>' : ""}
            `;

            // Click Handler
            item.onclick = () => {
                if (cmd.external) {
                    window.open(cmd.href, "_blank");
                } else {
                    window.location.href = cmd.href;
                }
                closePalette();
            };

            // Mouse over handler for index update
            item.onmouseenter = () => {
                selectedIndex = index;
                render(); // Re-render to update highlights (inefficient but safe for small lists)
            };

            resultsContainer.appendChild(item);
        });

        // Ensure selected item is visible
        const selectedEl =
            resultsContainer.querySelectorAll("button")[selectedIndex];
        if (selectedEl) {
            selectedEl.scrollIntoView({ block: "nearest" });
        }
    }

    // Event Listeners
    document.addEventListener("keydown", (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === "k") {
            e.preventDefault();
            openPalette();
        }

        if (dialog.open) {
            if (e.key === "ArrowDown") {
                e.preventDefault();
                selectedIndex = (selectedIndex + 1) % filteredCommands.length;
                render();
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                selectedIndex =
                    (selectedIndex - 1 + filteredCommands.length) %
                    filteredCommands.length;
                render();
            } else if (e.key === "Enter") {
                e.preventDefault();
                const cmd = filteredCommands[selectedIndex];
                if (cmd) {
                    if (cmd.external) {
                        window.open(cmd.href, "_blank");
                    } else {
                        window.location.href = cmd.href;
                    }
                    closePalette();
                }
            }
        }
    });

    input.addEventListener("input", (e) => {
        filterCommands((e.target as HTMLInputElement).value);
    });

    // Close on backdrop click
    dialog.addEventListener("click", (e) => {
        const rect = dialog.getBoundingClientRect();
        const isInDialog =
            rect.top <= e.clientY &&
            e.clientY <= rect.top + rect.height &&
            rect.left <= e.clientX &&
            e.clientX <= rect.left + rect.width;
        if (!isInDialog) {
            dialog.close();
        }
    });

    // Handle View Transitions (re-bind listeners if needed, though document listener persists)
    document.addEventListener("astro:after-swap", () => {
        // Re-attach if DOM was wiped
        const newDialog = document.getElementById(
            "command-palette",
        ) as HTMLDialogElement;
        // The script re-runs on swap? Astro default behavior for inline scripts is run-once unless is:inline?
        // Let's rely on the module script behavior.
    });
</script>

<style>
    /* Improve Scrollbar */
    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: #334155;
        border-radius: 999px;
    }
</style>
